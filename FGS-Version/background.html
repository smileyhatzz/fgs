<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script type="text/javascript" src="jquery-1.5.1.min.js"></script>

<script type="text/javascript">

function getInfo(uid, id, port)
{
	$.getJSON('http://rzadki.eu:81/projects/fgs/jsonp/info.php?callback=?&_t='+new Date().getTime(), {user: uid}, function(d) { port.postMessage({info: d.info, id: id, uid: uid}); });
}


function test(time)
{
	$.get('http://www.facebook.com/pagelet/generic.php/pagelet/home/morestories.php?__a=18&data={%22filter%22:%22appm_167746316127%22,%22scroll_count%22:2,%22delay_load_count%22:30,%22oldest%22:'+time+'}', function(d)
	{
		var d = d.slice(9);
		var x = JSON.parse(d);
		console.log($(x.payload).length);
		
		
		
		var time2 = 0;
		$(x.payload).each(function(k)
		{
			var el = $(this);
			
			var t = el.find('.UIActionLinks_bottom > a:last').text();
						var tmpDateStr = el.find('abbr').attr('data-date');
						
						if(typeof(tmpDateStr) == 'undefined')
							return;
						
						var bonusTimeTmp = new Date(tmpDateStr).getTime();					
						var bonusTime = Math.round(bonusTimeTmp / 1000);
						
			time2 = bonusTime;
			if(k == 0 || k == $(x.payload).length - 1)
				console.log(t, new Date(bonusTime*1000));
		});
		
		if(time2 != 0)
		{
			test(time2);
		}
		
		
	});
}

$(function()
{


	//test(Math.floor(new Date().getTime()/1000));

});













chrome.self.onConnect.addListener(function(port)
{
	port.onMessage.addListener(function(request)
	{
		if(request.uid)
		{
			getInfo(request.uid, request.id, port);
		}
	});
});
</script>
</head>
<body>
</body>
</html>